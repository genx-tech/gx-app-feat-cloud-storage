{"version":3,"sources":["../../src/drivers/s3.js"],"names":["S3Service","constructor","app","options","endpoint","accessKeyId","secretAccessKey","bucket","AWS","tryRequire","spacesEndpoint","Endpoint","client","S3","signatureVersion","getUploadUrl_","objectKey","contentType","payload","params","Bucket","Key","Expires","getSignedUrl","getDownloadUrl_","module","exports"],"mappings":";;;;AAAA,MAAMA,SAAN,CAAgB;AACZC,EAAAA,WAAW,CAACC,GAAD,EAAMC,OAAN,EAAe;AACtB,UAAM;AAAEC,MAAAA,QAAF;AAAYC,MAAAA,WAAZ;AAAyBC,MAAAA,eAAzB;AAA0CC,MAAAA;AAA1C,QAAqDJ,OAA3D;AAEA,UAAMK,GAAG,GAAGN,GAAG,CAACO,UAAJ,CAAe,SAAf,CAAZ;AAEA,UAAMC,cAAc,GAAG,IAAIF,GAAG,CAACG,QAAR,CAAiBP,QAAjB,CAAvB;AAEA,SAAKQ,MAAL,GAAc,IAAIJ,GAAG,CAACK,EAAR,CAAW;AACrBT,MAAAA,QAAQ,EAAEM,cADW;AAErBL,MAAAA,WAFqB;AAGrBC,MAAAA,eAHqB;AAIrBQ,MAAAA,gBAAgB,EAAE;AAJG,KAAX,CAAd;AAOA,SAAKP,MAAL,GAAcA,MAAd;AACH;;AAEkB,QAAbQ,aAAa,CAACC,SAAD,EAAYC,WAAZ,EAAyBC,OAAzB,EAAkC;AACjD,UAAMC,MAAM,GAAG;AACXC,MAAAA,MAAM,EAAE,KAAKb,MADF;AAEXc,MAAAA,GAAG,EAAEL,SAFM;AAGXM,MAAAA,OAAO,EAAE;AAHE,KAAf;;AAMA,QAAIL,WAAJ,EAAiB;AAEbE,MAAAA,MAAM,CAACF,WAAP,GAAqBA,WAArB;AACH;;AAED,WAAO,KAAKL,MAAL,CAAYW,YAAZ,CAAyB,WAAzB,EAAsC;AACzCJ,MAAAA,MADyC;AAEzC,SAAGD;AAFsC,KAAtC,CAAP;AAIH;;AAEoB,QAAfM,eAAe,CAACR,SAAD,EAAYE,OAAZ,EAAqB;AACtC,WAAO,KAAKN,MAAL,CAAYW,YAAZ,CAAyB,WAAzB,EAAsC;AACzCH,MAAAA,MAAM,EAAE,KAAKb,MAD4B;AAEzCc,MAAAA,GAAG,EAAEL,SAFoC;AAGzC,SAAGE;AAHsC,KAAtC,CAAP;AAKH;;AA1CW;;AA6ChBO,MAAM,CAACC,OAAP,GAAiB1B,SAAjB","sourcesContent":["class S3Service {\n    constructor(app, options) {\n        const { endpoint, accessKeyId, secretAccessKey, bucket } = options;\n\n        const AWS = app.tryRequire('aws-sdk');\n\n        const spacesEndpoint = new AWS.Endpoint(endpoint);\n\n        this.client = new AWS.S3({\n            endpoint: spacesEndpoint,\n            accessKeyId,\n            secretAccessKey,\n            signatureVersion: 'v4',\n        });\n\n        this.bucket = bucket;\n    }\n\n    async getUploadUrl_(objectKey, contentType, payload) {\n        const params = {\n            Bucket: this.bucket,\n            Key: objectKey,\n            Expires: 300,\n        };\n\n        if (contentType) {\n            // most of the time, you don't know the contentType before user selected the file\n            params.contentType = contentType;\n        }\n\n        return this.client.getSignedUrl('putObject', {\n            params,\n            ...payload,\n        });\n    }\n\n    async getDownloadUrl_(objectKey, payload) {\n        return this.client.getSignedUrl('getObject', {\n            Bucket: this.bucket,\n            Key: objectKey,\n            ...payload,\n        });\n    }\n}\n\nmodule.exports = S3Service;\n"],"file":"s3.js"}